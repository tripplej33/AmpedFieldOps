# Architecture Refactor Plan: Local+Cloud Supabase Setup

**Status:** Planning Phase  
**Target Date:** Next Session  
**Scope:** 2-3 hours of focused implementation  

---

## 1. Overview & Goals

### Current State
- ✅ Session persistence working (auth fixed)
- ✅ Backend can reach Supabase (networking fixed)
- ⚠️ Backend tightly coupled to frontend (all API routes duplicated)
- ⚠️ No cloud Supabase option (locked to self-hosted)
- ⚠️ Manual docker setup (no interactive prompts)
- ⚠️ Activity types hardcoded

### Target State
- ✅ **Toggle local ↔ cloud Supabase** (environment variable + interactive setup)
- ✅ **Frontend talks directly to Supabase** (RLS policies, no API for CRUD)
- ✅ **Backend reduced** to Xero OAuth + OCR only
- ✅ **Auto-migrations** on local startup
- ✅ **Configurable activity types** (CRUD in settings tab)
- ✅ **Backup features** (local→cloud, cloud→S3)
- ✅ **Data persistence** (Docker volumes for local, cloud backup for safety)

---

## 2. Detailed Implementation Plan

### Phase A: Setup & Configuration Infrastructure

#### A1: Interactive Setup Script
**File:** `./setup.sh` (new)  
**Triggers:** On first run (detect missing `.env` or `.supabase-mode`)

```bash
#!/bin/bash
# Prompts user to choose:
# 1. Use local Supabase (development/testing)
# 2. Use Supabase Cloud (production)
#
# Output:
# - .env file with SUPABASE_* variables
# - .supabase-mode file (local|cloud)
# - docker-compose overrides if needed

read -p "Setup Supabase: (1) Local Docker or (2) Cloud? [1/2] " choice
if [ "$choice" = "2" ]; then
  read -p "Enter SUPABASE_URL: " url
  read -sp "Enter SUPABASE_ANON_KEY: " key
  # ... set cloud variables
else
  # Default to local; docker-compose.yml handles startup
  echo "Using local Supabase. Run: supabase start"
fi

# Also prompt for:
# - Frontend URL (default: https://admin.ampedlogix.com for prod, http://localhost:5173 for dev)
# - Xero credentials (optional, can add later in settings)
# - SMTP credentials (optional)
```

#### A2: Environment Configuration
**Files Modified:**
- `.env.example` - template with SUPABASE_MODE, SUPABASE_URL, etc.
- `.env` - auto-generated by setup.sh (gitignored)
- `docker-compose.yml` - read from .env, support both modes

**Key Variables:**
```bash
SUPABASE_MODE=local|cloud
SUPABASE_URL=http://supabase_kong_AmpedFieldOps:8000 (local) or https://xxxxx.supabase.co (cloud)
SUPABASE_ANON_KEY=eyJ... (auto-detected from supabase start, or user-provided)
SUPABASE_SERVICE_ROLE_KEY=eyJ...
FRONTEND_URL=https://admin.ampedlogix.com (production) or http://localhost:5173 (dev)
```

#### A3: Docker Compose Conditionals
**Problem:** Single docker-compose.yml must work for both local & cloud Supabase  
**Solution:** 
- If `SUPABASE_MODE=local`, include `supabase` services (Kong, auth, db, etc.)
- If `SUPABASE_MODE=cloud`, skip Supabase services; only backend/frontend
- Use `compose.override.yml` or `${SUPABASE_MODE}` variable substitution

---

### Phase B: Frontend Refactor (Direct Supabase)

#### B1: Remove API Client Dependency
**Current:** `src/lib/api.ts` makes requests to `/api/clients`, `/api/projects`, etc.  
**Target:** Use `@supabase/supabase-js` directly with RLS policies

**Changes:**
1. Update `src/lib/supabase.ts` to use env variable from docker-compose:
   ```typescript
   const supabaseUrl = import.meta.env.VITE_SUPABASE_URL || 
     (window.location.hostname === 'localhost' 
       ? 'http://localhost:54321' 
       : 'https://xxxxx.supabase.co');
   ```

2. Replace API calls in components:
   ```typescript
   // Before:
   const clients = await api.get('/api/clients');
   
   // After:
   const { data: clients } = await supabase
     .from('clients')
     .select('*')
     .eq('organization_id', userOrgId);
   ```

3. Components affected:
   - `Clients.tsx` → direct `clients` table query
   - `Projects.tsx` → direct `projects` table query
   - `Timesheets.tsx` → direct `timesheets` table query
   - `Dashboard.tsx` → direct RLS queries
   - `Search.tsx` → direct search via RPC or filters

#### B2: RLS Policies (Critical Security)
**New File:** `supabase/migrations/20260119_rls_policies.sql`

```sql
-- Clients: Users can only see clients in their organization
CREATE POLICY "Organizations can view their own clients"
  ON clients FOR SELECT
  USING (organization_id = auth.uid());

-- Projects: Scoped to user's organization
CREATE POLICY "Organizations can view their own projects"
  ON projects FOR SELECT
  USING (organization_id = auth.uid());

-- Timesheets: Scoped to user's organization
CREATE POLICY "Users can only see timesheets in their organization"
  ON timesheets FOR SELECT
  USING (
    organization_id IN (
      SELECT id FROM organizations WHERE owner_id = auth.uid()
    )
  );

-- Activity Types: Public read, org members can manage
CREATE POLICY "Activity types are readable to authenticated users"
  ON activity_types FOR SELECT
  USING (TRUE);

CREATE POLICY "Users can create activity types in their organization"
  ON activity_types FOR INSERT
  USING (organization_id = auth.uid());
```

#### B3: Remove Dead API Routes
**Delete from `backend/src/routes/`:**
- `clients.ts` (except admin endpoints)
- `projects.ts` (except admin endpoints)
- `timesheets.ts` (except admin endpoints, cost rollups)
- `search.ts` (replace with Supabase FTS or RPC)
- `dashboard.ts` (frontend can query directly)
- `costCenters.ts` (keep if complex calculations needed)

**Keep:**
- `auth.ts` (for Supabase magic link auth)
- `xero.ts` (OAuth, token management)
- `ocr.ts` (file processing)
- `settings.ts` (org settings, credentials)
- `backups.ts` (new: backup management)

---

### Phase C: Backend Reduction

#### C1: Remove Unnecessary Routes
**Impact Analysis:**
- `/api/clients` - Move to RLS directly (0.5 hrs)
- `/api/projects` - Move to RLS directly (0.5 hrs)
- `/api/timesheets` - Move to RLS (0.5 hrs)
- `/api/dashboard` - Move to RLS + Postgres aggregations (1 hr)
- `/api/search` - Use Supabase full-text search (1 hr)

#### C2: Keep & Enhance
**Xero Integration:**
- `/api/xero/auth/url` - OAuth flow start
- `/api/xero/callback` - OAuth callback
- `/api/xero/sync` - Background job to sync invoices
- `/api/xero/status` - Check if connected

**OCR & Document Processing:**
- `/api/ocr/process` - Send document to OCR service
- `/api/documents/scan` - Handle scanned uploads

**Settings & Admin:**
- `/api/settings` - Get/update org settings (Xero creds, etc.)
- `/api/activity-types` - CRUD activity types
- `/api/backups` - Schedule/manage backups

#### C3: Cost Tracking (Keep in Backend)
**Why:** Timesheets with `actual_cost` rollup requires complex calculations  
**Logic:**
```typescript
// GET /api/projects/:id/costs
// Calculates: sum of (timesheet.hours * activity_type.hourly_rate)
// Falls back to: project.hourly_rate if custom rate not set
```

---

### Phase D: Database & Migrations

#### D1: Auto-Migration Setup
**File:** `backend/src/jobs/migrationRunner.ts` (new)

```typescript
export async function runMigrations() {
  if (process.env.SUPABASE_MODE !== 'local') {
    console.log('[Migrations] Skipping auto-run for cloud Supabase');
    return;
  }

  const migrationsPath = path.join(__dirname, '../../supabase/migrations');
  const files = fs.readdirSync(migrationsPath).sort();

  for (const file of files) {
    const sql = fs.readFileSync(path.join(migrationsPath, file), 'utf-8');
    try {
      await supabase.rpc('exec_sql', { sql }); // or direct admin API
      console.log(`✅ Ran migration: ${file}`);
    } catch (error) {
      console.error(`❌ Migration failed: ${file}`, error);
    }
  }
}

// Call in server.ts startup
```

#### D2: Seeding Activity Types
**File:** `backend/src/jobs/seedActivityTypes.ts` (new)

```typescript
export async function seedActivityTypes() {
  const defaults = [
    { name: 'General Labor', hourly_rate: 50 },
    { name: 'Equipment Operation', hourly_rate: 75 },
    { name: 'Supervision', hourly_rate: 100 },
    { name: 'Safety Training', hourly_rate: 60 },
  ];

  for (const type of defaults) {
    const { error } = await supabase
      .from('activity_types')
      .insert({ ...type, organization_id: null }) // Global defaults
      .onConflict('name')
      .ignore();

    if (error) console.error(`Seed failed for ${type.name}:`, error);
  }
}
```

#### D3: Migration Files
**New:** `supabase/migrations/20260119_rls_policies.sql` (as above)

---

### Phase E: Backup & Data Persistence

#### E1: Local Persistence
**Docker Volumes:**
```yaml
volumes:
  postgres_data: # Supabase database
  supabase_storage: # File uploads
```

**No setup needed:** Docker handles persistence automatically

#### E2: Cloud Backup Strategy
**File:** `backend/src/jobs/backupScheduler.ts` (enhance existing)

**Option A: pg_dump to S3**
```typescript
// Daily at 2 AM
const backupPath = `/tmp/backup-${Date.now()}.sql.gz`;
const stream = fs.createWriteStream(backupPath);
const pgDumpProcess = spawn('pg_dump', [connectionString]);
pgDumpProcess.stdout.pipe(zlib.createGzip()).pipe(stream);
// Upload to S3 or B2
```

**Option B: Supabase Cloud Sync**
```typescript
// One-time: Copy data from local to Supabase Cloud
// Periodic: Sync settings/configs (not full data)
```

**User Control:** Add to Settings tab
```tsx
// Settings > Backups
- "Last backup: 2026-01-19 02:00 UTC"
- "Backup frequency: Daily"
- "Backup destination: AWS S3"
- [Manual Backup Now] button
- [Download Backup] button (last 7 backups)
```

---

### Phase F: Settings Tab Enhancements

#### F1: Activity Type Management
```tsx
// Settings > Activity Types
- List all activity types (sortable, filterable)
- [+ Add Activity Type] button
  - Name, Hourly Rate, [Save]
- [Edit] button per row
- [Delete] button with confirmation
- Toggle "Default" flag
```

**Database:** `activity_types` table with user-scoped records

#### F2: Backup Management
```tsx
// Settings > Backups & Data
- Backup Schedule: [Daily] [Weekly] [Monthly]
- Backup Destination: [Local Only] [S3] [Supabase Cloud]
- Manual Actions:
  - [Backup Now]
  - [Download Latest Backup]
  - [Restore from Backup] (upload file)
  - [View Backup History] (table of past backups)
```

**Backend Endpoints:**
- `POST /api/backups/now` - Trigger immediate backup
- `GET /api/backups/list` - List available backups
- `POST /api/backups/restore` - Restore from backup
- `PATCH /api/backups/schedule` - Update frequency

---

## 3. Implementation Sequence (Recommended)

### Session 1 (2-3 hours)
1. **A1-A2:** Setup script + env config (0.5 hrs)
2. **B1-B2:** Frontend refactor + RLS policies (1 hr)
3. **C1-C2:** Remove/reduce backend routes (0.5 hrs)
4. **Test:** Login → CRUD clients/projects/timesheets directly (0.5 hrs)

### Session 2 (1-2 hours)
5. **D1-D3:** Auto-migrations + seeding (0.5 hrs)
6. **E1-E2:** Backup setup + S3 integration (0.75 hrs)
7. **F1-F2:** Settings tab enhancements (0.75 hrs)

### Session 3 (Testing & Polish)
8. Test local → cloud toggle
9. Test backup/restore flow
10. Production deployment

---

## 4. Risk Mitigation

### RLS Policy Complexity
**Risk:** Incorrect policies leak data between orgs  
**Mitigation:**
- Write tests for each policy (check-policies.sql)
- Start with restrictive (deny all, allow specific)
- Test with multiple org accounts

### Data Loss During Migration
**Risk:** Removing API routes breaks existing frontend code  
**Mitigation:**
- Feature flag old API routes (keep them, log deprecation warnings)
- Parallel test (run both old + new code, compare results)
- Rollback plan: revert docker-compose to previous image

### Cloud vs Local Config
**Risk:** Users accidentally deploy cloud creds to local, or vice versa  
**Mitigation:**
- Setup script stores mode in `.supabase-mode` (checked on startup)
- Warn in logs if mismatch detected (e.g., cloud URL + local mode)
- Env vars are strictly validated

---

## 5. Files to Create/Modify

### New Files
- `./setup.sh` - interactive setup script
- `backend/src/jobs/migrationRunner.ts` - auto-run migrations
- `backend/src/jobs/seedActivityTypes.ts` - seed defaults
- `backend/src/routes/backups.ts` - enhance (new endpoints)
- `supabase/migrations/20260119_rls_policies.sql` - security policies
- `.env.example` - template
- `.supabase-mode` - mode tracker (created by setup.sh, gitignored)

### Modified Files
- `docker-compose.yml` - conditional services, env from .env
- `frontend/Dockerfile` - pass VITE_SUPABASE_URL from env
- `src/lib/supabase.ts` - use env variable
- `src/contexts/AuthContext.tsx` - already fixed ✅
- `backend/src/routes/xero.ts` - keep as-is
- `backend/src/routes/ocr.ts` - keep as-is
- `backend/src/routes/settings.ts` - enhance activity types + backups
- `backend/src/server.ts` - call migration runner, seed on startup
- Various `.tsx` files - replace API calls with Supabase queries

### Files to Delete
- `backend/src/routes/clients.ts`
- `backend/src/routes/projects.ts`
- `backend/src/routes/timesheets.ts`
- `backend/src/routes/search.ts`
- `backend/src/routes/dashboard.ts`
- `backend/src/routes/costCenters.ts` (maybe; depends on logic)

---

## 6. Timeline & Dependencies

```
Week 1:
  Mon: A1-A2 (setup + env)
  Tue: B1-B2 (frontend refactor + RLS)
  Wed: C1-C2 (backend reduction)
  Thu: D1-D3 (migrations)
  Fri: E1-E2 (backups) + F1-F2 (settings)

Week 2:
  Testing & refinement
  Production deployment
```

**Blocking Dependencies:**
- Setup script needed before backend/frontend changes
- RLS policies needed before removing API routes
- Migration runner needed before seeding

**No blockers:** Backup & settings can be done in parallel

---

## 7. Success Criteria

- [ ] `./setup.sh` prompts user (local or cloud)
- [ ] Frontend queries Supabase directly (no `/api/clients` calls)
- [ ] RLS policies prevent cross-org data leaks
- [ ] Timesheets CRUD works with cost rollup
- [ ] Activity types can be added/deleted in settings
- [ ] Backups scheduled & downloadable
- [ ] Toggle between local & cloud Supabase (no code changes)
- [ ] All tests pass (frontend + backend)
- [ ] Docs updated with setup instructions

---

## 8. Open Questions for User

1. **Activity Type Import/Export:** Should we support bulk import from CSV?
2. **Backup Encryption:** Should backups be encrypted at rest?
3. **Audit Logging:** Should we track all CRUD operations (org compliance)?
4. **Cost Calculations:** Should actual_cost override hourly_rate, or is it calculated-only?
5. **Multi-Organization:** Is this a multi-tenant app, or single-org-per-instance?
   - (Affects RLS policy complexity significantly)

---

**Last Updated:** 2026-01-19  
**Status:** READY FOR IMPLEMENTATION  
**Estimated Effort:** 8-10 hours across 2-3 sessions
